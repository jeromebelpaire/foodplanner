{% load static %}
<!DOCTYPE html>
<html>
  <head>
    <title>Recipe Sum</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <script
      src="https://code.jquery.com/jquery-3.7.0.min.js"
      integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g="
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <div class="container py-5">
      <form id="create-grocery-list-form" method="post">
        {% csrf_token %}
        <label for="name">Name:</label><br />
        <input type="text" id="name" name="name" required /><br />
        <input type="submit" class="btn btn-primary my-1" value="Create New List" />
      </form>
      <form id="grocery-list-form" class="my-2" method="post">
        {% csrf_token %} {{ grocery_list_form.as_p }}
        <button type="submit" class="btn btn-primary">Select Existing</button>
      </form>
      <form id="recipe-form" method="post">
        <p>Please select and submit a grocery list first</p>
        {% include 'recipes/recipe_form.html' %}
      </form>
      <h2 class="my-5">Ingredients</h2>
      <ul id="ingredients" class="list-group"></ul>
    </div>
    <script>
      $(document).ready(function () {
        $("#create-grocery-list-form").submit(function (e) {
          e.preventDefault();

          $.ajax({
            url: "{% url 'create_grocery_list' %}",
            type: "POST",
            data: {
              name: $("#name").val(),
              csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val(),
            },
            success: function (response) {
              alert("Grocery list created successfully!");
              location.reload();
            },
          });
        });

        $("#grocery-list-form").submit(function (e) {
          e.preventDefault();
          var form_data = $(this).serialize();
          $.ajax({
            url: "{% url 'generate_recipe_select_form' %}",
            method: "POST",
            data: form_data,
            success: function (data) {
              generate_recipe_select_form(data);
            },
          });
          $.ajax({
            url: "{% url 'get_planned_ingredients' %}",
            method: "GET",
            data: form_data,
            success: function (data) {
              update_ingredients_list(data);
            },
          });
        });
      });

      $("#recipe-form").submit(function (e) {
        e.preventDefault();
        var form_data1 = $(this).serializeArray();
        var form_data_grocery_list = $("#grocery-list-form").serializeArray();

        var groceryList = form_data_grocery_list.find(function (item) {
          return item.name === "grocery_list";
        });

        if (groceryList) {
          form_data1.push(groceryList);
        }
        var form_data = $.param(form_data1);
        $.ajax({
          url: "{% url 'save_planned_recipe' %}",
          method: "POST",
          data: form_data,
          success: function (data) {
            if (data.success) {
              $.ajax({
                url: "{% url 'get_planned_ingredients' %}",
                method: "GET",
                data: form_data,
                success: function (data) {
                  update_ingredients_list(data);
                },
              });
            }
          },
        });
      });
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
      crossorigin="anonymous"
    ></script>
    <script src="{% static 'recipes/update_ingredients_list.js' %}"></script>
    <script src="{% static 'recipes/generate_recipe_select_form.js' %}"></script>
  </body>
</html>
